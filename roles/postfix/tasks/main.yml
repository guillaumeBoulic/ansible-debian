---
# Defines tasks to install and configure Postfix

- name: Create pre-seed values for Postfix configuration
  template: >
    src=tmp-postfix_selections.j2
    dest=/tmp/postfix_selections
    mode=0644 owner=root group=root
  register: preseed_template
  tags:
    - common
    - postfix

- name: Install packages for Debian derivatives
  apt: >
    pkg={{ item }}
    update_cache=yes
    state=latest
  with_items: postfix_packages
  tags:
    - common
    - postfix

- name: Write Postfix configuration template
  template: >
    src=main-cf.j2
    dest={{ postfix_config_dir }}/main.cf
    mode=0644 owner=root group=root
    backup=yes
  notify:
    - restart postfix
    - send test email
  tags:
    - common
    - postfix

- name: Start Postfix on server boot
  service: >
    name={{ postfix_service }}
    state=started
    enabled=yes
  tags:
    - common
    - postfix

- name: ad dovecot to master.cf
  lineinfile: dest={{ postfix_config_dir }}/master.cf line="{{ item }}" state=present insertafter=EOF
  with_items:
    - "# Dovecot LDA"
    - "dovecot   unix  -       n       n       -       -       pipe"
    - "  flags=DRhu user=vmail:vmail argv=/usr/lib/dovecot/deliver -f ${sender} -d ${recipient}"

- name: setting-up of the virtual alias map
  template: >
    src=virtual_alias_maps.j2
    dest={{ postfix_config_dir }}/virtual_alias_maps
    mode=0644 owner=root group=root
    backup=yes
  notify:
    - restart postfix

- name: setting-up of the virtual mailbox domains
  template: >
    src=virtual_mailbox_domains.j2
    dest={{ postfix_config_dir }}/virtual_mailbox_domains
    mode=0644 owner=root group=root
    backup=yes
  notify:
    - restart postfix

- name: setting-up of the virtual mailbox maps
  template: >
    src=virtual_mailbox_maps.j2
    dest={{ postfix_config_dir }}/virtual_mailbox_maps
    mode=0644 owner=root group=root
    backup=yes
  notify:
    - restart postfix

- name: update of the 3 db with postmap
  command: postmap {{ item }}
  with_items:
    - "{{ postfix_config_dir }}/virtual_mailbox_domains"
    - "{{ postfix_config_dir }}/virtual_mailbox_maps"
    - "{{ postfix_config_dir }}/virtual_alias_maps"
